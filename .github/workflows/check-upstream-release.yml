name: Check Upstream Release

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 8:00 æ£€æŸ¥ (åŒ—äº¬æ—¶é—´ 16:00)
    - cron: '0 8 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get upstream latest release
        id: upstream
        run: |
          UPSTREAM_RELEASE=$(curl -s https://api.github.com/repos/2dust/v2rayN/releases/latest | jq -r '.tag_name')
          echo "release=$UPSTREAM_RELEASE" >> $GITHUB_OUTPUT
          echo "Upstream latest release: $UPSTREAM_RELEASE"

      - name: Get our latest release
        id: current
        run: |
          OUR_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name // "none"')
          echo "release=$OUR_RELEASE" >> $GITHUB_OUTPUT
          echo "Our latest release: $OUR_RELEASE"

      - name: Compare versions
        id: compare
        run: |
          UPSTREAM="${{ steps.upstream.outputs.release }}"
          CURRENT="${{ steps.current.outputs.release }}"

          # ç§»é™¤ç‰ˆæœ¬å·å‰ç¼€è¿›è¡Œæ¯”è¾ƒ
          UPSTREAM_VER=$(echo "$UPSTREAM" | sed 's/^v//')
          CURRENT_VER=$(echo "$CURRENT" | sed 's/^v//' | sed 's/-multiport$//')

          if [ "$UPSTREAM_VER" != "$CURRENT_VER" ]; then
            echo "new_release=true" >> $GITHUB_OUTPUT
            echo "New upstream release detected: $UPSTREAM (current: $CURRENT)"
          else
            echo "new_release=false" >> $GITHUB_OUTPUT
            echo "No new release"
          fi

      - name: Create issue for new release
        if: steps.compare.outputs.new_release == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const upstreamRelease = '${{ steps.upstream.outputs.release }}';
            const currentRelease = '${{ steps.current.outputs.release }}';

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes(upstreamRelease)
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”„ New upstream release: ${upstreamRelease}`,
                body: `## Upstream Release Detected\n\n` +
                      `**Upstream version**: ${upstreamRelease}\n` +
                      `**Current version**: ${currentRelease}\n\n` +
                      `### Action Required\n` +
                      `1. Run the "Sync Upstream" workflow to merge upstream changes\n` +
                      `2. Resolve any conflicts with multi-port feature\n` +
                      `3. Test the build locally\n` +
                      `4. Create a new release\n\n` +
                      `[View upstream release](https://github.com/2dust/v2rayN/releases/tag/${upstreamRelease})`,
                labels: ['upstream-sync', 'automated']
              });
              console.log('Issue created for new release');
            } else {
              console.log('Issue already exists for this release');
            }
