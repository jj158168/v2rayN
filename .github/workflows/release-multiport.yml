name: Release Multi-Port Version

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., 7.17.0-multiport)'
        required: true
        type: string

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  # è¿è¡Œæµ‹è¯•
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Verify Multi-Port Feature
        run: |
          echo "=== Verifying Multi-Port Feature ==="

          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          test -f "v2rayN/ServiceLib/Manager/MultiCoreManager.cs" || exit 1
          grep -q "CustomLocalPort" "v2rayN/ServiceLib/Models/ProfileItem.cs" || exit 1
          grep -q "RunningStatus" "v2rayN/ServiceLib/Models/ProfileItemModel.cs" || exit 1

          echo "âœ… All feature checks passed"

  prepare:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.value }}
      version: ${{ steps.version.outputs.value }}
      upstream_version: ${{ steps.version.outputs.upstream }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "value=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "value=${{ inputs.release_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Extract version info
        id: version
        run: |
          TAG="${{ steps.tag.outputs.value }}"
          # æå–ç‰ˆæœ¬å· (å»é™¤ -multiport åç¼€)
          VERSION=$(echo "$TAG" | sed 's/-multiport$//')
          echo "value=$VERSION" >> $GITHUB_OUTPUT

          # è·å–ä¸Šæ¸¸ç‰ˆæœ¬
          UPSTREAM=$(echo "$VERSION" | sed 's/^v//')
          echo "upstream=$UPSTREAM" >> $GITHUB_OUTPUT

          echo "Tag: $TAG"
          echo "Version: $VERSION"
          echo "Upstream: $UPSTREAM"

  build-windows:
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build Windows x64
        run: |
          cd v2rayN
          dotnet publish ./v2rayN/v2rayN.csproj -c Release -r win-x64 --self-contained -o ../publish/win-x64
          dotnet publish ./AmazTool/AmazTool.csproj -c Release -r win-x64 -p:PublishTrimmed=true --self-contained -o ../publish/win-x64

      - name: Build Windows x86
        run: |
          cd v2rayN
          dotnet publish ./v2rayN/v2rayN.csproj -c Release -r win-x86 --self-contained -o ../publish/win-x86
          dotnet publish ./AmazTool/AmazTool.csproj -c Release -r win-x86 -p:PublishTrimmed=true --self-contained -o ../publish/win-x86

      - name: Build Windows arm64
        run: |
          cd v2rayN
          dotnet publish ./v2rayN/v2rayN.csproj -c Release -r win-arm64 --self-contained -o ../publish/win-arm64
          dotnet publish ./AmazTool/AmazTool.csproj -c Release -r win-arm64 -p:PublishTrimmed=true --self-contained -o ../publish/win-arm64

      - name: Package
        run: |
          $TAG = "${{ needs.prepare.outputs.tag }}"
          cd publish
          Compress-Archive -Path win-x64\* -DestinationPath "..\v2rayN-windows-x64-${TAG}.zip"
          Compress-Archive -Path win-x86\* -DestinationPath "..\v2rayN-windows-x86-${TAG}.zip"
          Compress-Archive -Path win-arm64\* -DestinationPath "..\v2rayN-windows-arm64-${TAG}.zip"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: "*.zip"

  build-linux:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build Linux x64
        run: |
          cd v2rayN
          dotnet publish ./v2rayN.Desktop/v2rayN.Desktop.csproj -c Release -r linux-x64 --self-contained -o ../publish/linux-x64
          dotnet publish ./AmazTool/AmazTool.csproj -c Release -r linux-x64 -p:PublishTrimmed=true --self-contained -o ../publish/linux-x64

      - name: Build Linux arm64
        run: |
          cd v2rayN
          dotnet publish ./v2rayN.Desktop/v2rayN.Desktop.csproj -c Release -r linux-arm64 --self-contained -o ../publish/linux-arm64
          dotnet publish ./AmazTool/AmazTool.csproj -c Release -r linux-arm64 -p:PublishTrimmed=true --self-contained -o ../publish/linux-arm64

      - name: Package
        run: |
          TAG="${{ needs.prepare.outputs.tag }}"
          cd publish
          tar -czvf "../v2rayN-linux-x64-${TAG}.tar.gz" linux-x64
          tar -czvf "../v2rayN-linux-arm64-${TAG}.tar.gz" linux-arm64

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: "*.tar.gz"

  build-macos:
    needs: prepare
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build macOS x64
        run: |
          cd v2rayN
          dotnet publish ./v2rayN.Desktop/v2rayN.Desktop.csproj -c Release -r osx-x64 --self-contained -o ../publish/osx-x64
          dotnet publish ./AmazTool/AmazTool.csproj -c Release -r osx-x64 -p:PublishTrimmed=true --self-contained -o ../publish/osx-x64

      - name: Build macOS arm64
        run: |
          cd v2rayN
          dotnet publish ./v2rayN.Desktop/v2rayN.Desktop.csproj -c Release -r osx-arm64 --self-contained -o ../publish/osx-arm64
          dotnet publish ./AmazTool/AmazTool.csproj -c Release -r osx-arm64 -p:PublishTrimmed=true --self-contained -o ../publish/osx-arm64

      - name: Package
        run: |
          TAG="${{ needs.prepare.outputs.tag }}"
          cd publish
          zip -r "../v2rayN-macos-x64-${TAG}.zip" osx-x64
          zip -r "../v2rayN-macos-arm64-${TAG}.zip" osx-arm64

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: "*.zip"

  upload-release:
    needs: [prepare, build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "=== Release Artifacts ==="
          ls -la artifacts/
          echo ""
          echo "=== File Sizes ==="
          du -h artifacts/*

      - name: Generate release notes
        id: notes
        run: |
          TAG="${{ needs.prepare.outputs.tag }}"
          VERSION="${{ needs.prepare.outputs.version }}"
          UPSTREAM="${{ needs.prepare.outputs.upstream_version }}"

          cat > release_notes.md << 'EOF'
          ## v2rayN Multi-Port Edition

          åŸºäº [v2rayN](https://github.com/2dust/v2rayN) å®˜æ–¹ç‰ˆæœ¬ `$VERSION` ä¿®æ”¹ï¼Œæ·»åŠ å¤šèŠ‚ç‚¹åŒæ—¶è¿è¡ŒåŠŸèƒ½ã€‚

          ### âœ¨ æ–°å¢åŠŸèƒ½

          - **å¤šèŠ‚ç‚¹åŒæ—¶è¿è¡Œ**: æ”¯æŒåŒæ—¶å¯åŠ¨å¤šä¸ªä»£ç†èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨ç‹¬ç«‹çš„æœ¬åœ°ç«¯å£
          - **è‡ªå®šä¹‰æœ¬åœ°ç«¯å£**: å¯ä¸ºæ¯ä¸ªèŠ‚ç‚¹å•ç‹¬è®¾ç½®æœ¬åœ°ç›‘å¬ç«¯å£
          - **è¿è¡ŒçŠ¶æ€æ˜¾ç¤º**: åœ¨æœåŠ¡å™¨åˆ—è¡¨ä¸­æ˜¾ç¤ºæ¯ä¸ªèŠ‚ç‚¹çš„è¿è¡ŒçŠ¶æ€å’Œæœ¬åœ°ç«¯å£
          - **å³é”®èœå•æ“ä½œ**: é€šè¿‡å³é”®èœå•å¿«é€Ÿå¯åŠ¨/åœæ­¢å•ä¸ªèŠ‚ç‚¹

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜

          | å¹³å° | æ¶æ„ | æ–‡ä»¶ |
          |------|------|------|
          | Windows | x64 | `v2rayN-windows-x64-$TAG.zip` |
          | Windows | x86 | `v2rayN-windows-x86-$TAG.zip` |
          | Windows | ARM64 | `v2rayN-windows-arm64-$TAG.zip` |
          | Linux | x64 | `v2rayN-linux-x64-$TAG.tar.gz` |
          | Linux | ARM64 | `v2rayN-linux-arm64-$TAG.tar.gz` |
          | macOS | x64 (Intel) | `v2rayN-macos-x64-$TAG.zip` |
          | macOS | ARM64 (Apple Silicon) | `v2rayN-macos-arm64-$TAG.zip` |

          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•

          1. **è®¾ç½®è‡ªå®šä¹‰ç«¯å£**: ç¼–è¾‘æœåŠ¡å™¨ â†’ å¡«å†™"è‡ªå®šä¹‰æœ¬åœ°ç«¯å£"
          2. **å¯åŠ¨èŠ‚ç‚¹**: å³é”®ç‚¹å‡»æœåŠ¡å™¨ â†’ é€‰æ‹©"å¯åŠ¨èŠ‚ç‚¹"
          3. **åœæ­¢èŠ‚ç‚¹**: å³é”®ç‚¹å‡»æœåŠ¡å™¨ â†’ é€‰æ‹©"åœæ­¢èŠ‚ç‚¹"
          4. **æŸ¥çœ‹çŠ¶æ€**: "çŠ¶æ€"åˆ—æ˜¾ç¤ºè¿è¡ŒçŠ¶æ€ï¼Œ"æœ¬åœ°ç«¯å£"åˆ—æ˜¾ç¤ºç›‘å¬ç«¯å£

          ### âš ï¸ æ³¨æ„äº‹é¡¹

          - ç¡®ä¿ä¸ºæ¯ä¸ªåŒæ—¶è¿è¡Œçš„èŠ‚ç‚¹è®¾ç½®ä¸åŒçš„æœ¬åœ°ç«¯å£
          - å¦‚æœæœªè®¾ç½®è‡ªå®šä¹‰ç«¯å£ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é…å¯ç”¨ç«¯å£
          - å¤šèŠ‚ç‚¹åŠŸèƒ½ä¸ä¸»èŠ‚ç‚¹ï¼ˆç³»ç»Ÿä»£ç†ï¼‰ç›¸äº’ç‹¬ç«‹

          ### ğŸ”— ç›¸å…³é“¾æ¥

          - [ä¸Šæ¸¸ç‰ˆæœ¬ v$UPSTREAM](https://github.com/2dust/v2rayN/releases/tag/$VERSION)
          - [é—®é¢˜åé¦ˆ](../../issues)

          ---

          > æ­¤ç‰ˆæœ¬è‡ªåŠ¨æ„å»ºäº GitHub Actions
          EOF

          # æ›¿æ¢å˜é‡
          sed -i "s/\$TAG/$TAG/g" release_notes.md
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md
          sed -i "s/\$UPSTREAM/$UPSTREAM/g" release_notes.md

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          body_path: release_notes.md
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
